<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}To Do App{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  {% block head_extra %}{% endblock %}
</head>
<body class="theme-{{ current_theme or 'light' }}" data-theme="{{ current_theme or 'light' }}" data-initial-theme="{{ current_theme or 'light' }}" data-save-theme-url="{{ url_for('theme_update') if current_username else "" }}" data-csrf="{{ csrf_token() }}">
  {% set current_theme_value = current_theme or 'light' %}
  <button id="themeToggle" class="theme-toggle-button" type="button" data-theme="{{ current_theme_value }}" aria-label="Switch to {% if current_theme_value == 'dark' %}light{% else %}dark{% endif %} mode" aria-pressed="{{ 'true' if current_theme_value == 'dark' else 'false' }}" title="Switch to {% if current_theme_value == 'dark' %}light{% else %}dark{% endif %} mode">
    <span class="theme-toggle-icon" aria-hidden="true">{% if current_theme_value == 'dark' %}&#9728;{% else %}&#9790;{% endif %}</span>
  </button>
  {% set authed = session.get('username') %}
  {% with flashes = get_flashed_messages(with_categories=true) %}
    {% if flashes %}
      {% set category_icons = {'success': '‚úÖ', 'info': '‚ÑπÔ∏è', 'warning': '‚ö†Ô∏è', 'danger': '‚ùó'} %}
      <div id="toastStack" class="toast-stack" aria-live="polite" aria-atomic="true">
        {% for category, message in flashes %}
          <div class="toast notification-toast notification-toast-{{ category }}" role="status" data-category="{{ category }}" data-bs-autohide="true" data-bs-delay="4500">
            <div class="toast-body">
              <span class="toast-icon" aria-hidden="true">{{ category_icons.get(category, 'üîî') }}</span>
              <span class="toast-message">{{ message }}</span>
              <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  {% set role_for_layout = current_role if authed else 'member' %}
  <header class="app-header" role="banner">
    <div class="brand-area">
      {% if authed %}
        <button class="sidebar-toggle" type="button" aria-label="Toggle navigation" data-sidebar-toggle>
          <span class="sidebar-toggle-icon" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </button>
      {% endif %}
      <a class="app-logo" href="{{ url_for('dashboard') if authed else url_for('index') }}">To Do App</a>
    </div>
    <div class="header-actions">
      {% if authed %}
        <div class="dropdown">
          <button class="btn btn-link user-toggle dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
            {{ current_user_display or current_username }}
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
            <li><a class="dropdown-item" href="{{ url_for('profile') }}">Profile</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('logout') }}" onclick="return confirm('Are you sure you want to log out?')">Logout</a></li>
          </ul>
        </div>
      {% else %}
        <div class="header-auth">
          <a class="header-link" href="{{ url_for('login') }}">Log In</a>
          <a class="header-link primary" href="{{ url_for('signup') }}">Sign Up</a>
        </div>
      {% endif %}
    </div>
  </header>
  <div class="sidebar-backdrop" data-sidebar-toggle></div>
  <div class="app-shell">
    {% if ((show_sidebar is not defined) and authed) or (show_sidebar and authed) %}
      {% include "_sidebar.html" %}
    {% endif %}
    <main id="content" class="main-content" role="main">
      {% if DEMO %}
        <div class="demo-banner">
          <strong>Demo Mode</strong> &mdash; data is fake and mutations are disabled.
        </div>
      {% endif %}
      {% if breadcrumbs %}
        <nav class="breadcrumb-bar" aria-label="Breadcrumb">
          <ol class="breadcrumb">
            {% for crumb in breadcrumbs %}
              {% if crumb.url and not loop.last %}
                <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.title }}</a></li>
              {% else %}
                <li class="breadcrumb-item{% if loop.last %} active{% endif %}"{% if loop.last %} aria-current="page"{% endif %}>{{ crumb.title }}</li>
              {% endif %}
            {% endfor %}
          </ol>
        </nav>
      {% endif %}
      {% block content %}{% endblock %}
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
  <script>
    (function () {
      const body = document.body;
      const toggle = document.getElementById('themeToggle');
      const icon = toggle ? toggle.querySelector('.theme-toggle-icon') : null;
      const storageKey = 'themePreference';
      const saveUrl = body.dataset.saveThemeUrl || '';
      const csrfToken = body.dataset.csrf || '';

      function setButtonState(theme) {
        if (!toggle) { return; }
        const isDark = theme === 'dark';
        const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        toggle.setAttribute('aria-label', label);
        toggle.setAttribute('title', label);
        toggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
        toggle.dataset.theme = theme;
        if (icon) {
          icon.innerHTML = isDark ? '&#9728;' : '&#9790;';
        }
      }

      function applyTheme(theme, options) {
        options = options || {};
        const persistLocal = options.persistLocal !== undefined ? options.persistLocal : true;
        const notifyServer = options.notifyServer !== undefined ? options.notifyServer : !!saveUrl;
        const target = theme === 'dark' ? 'dark' : 'light';
        if (!body.classList.contains('theme-' + target)) {
          body.classList.remove('theme-light', 'theme-dark');
          body.classList.add('theme-' + target);
        }
        body.dataset.theme = target;
        if (persistLocal) {
          try {
            localStorage.setItem(storageKey, target);
          } catch (error) {
            /* ignore */
          }
        }
        setButtonState(target);
        if (notifyServer && saveUrl) {
          fetch(saveUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ theme: target })
          }).catch(function () { /* ignore */ });
        }
        return target;
      }

      window.applyTheme = applyTheme;

      var stored = null;
      try {
        stored = localStorage.getItem(storageKey);
      } catch (error) {
        stored = null;
      }

      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
      let hasUserPreference = !!stored;
      const initial = stored || body.dataset.initialTheme || (prefersDark.matches ? 'dark' : 'light');
      applyTheme(initial, { persistLocal: stored === null, notifyServer: false });

      if (toggle) {
        toggle.addEventListener('click', function () {
          const current = body.dataset.theme === 'dark' ? 'dark' : 'light';
          const next = current === 'dark' ? 'light' : 'dark';
          applyTheme(next, { persistLocal: true, notifyServer: true });
          hasUserPreference = true;
        });
      }

      if (!hasUserPreference) {
        const handleSchemeChange = function (event) {
          applyTheme(event.matches ? 'dark' : 'light', { persistLocal: false, notifyServer: true });
        };
        if (prefersDark.addEventListener) {
          prefersDark.addEventListener('change', handleSchemeChange);
        } else if (prefersDark.addListener) {
          prefersDark.addListener(handleSchemeChange);
        }
      }
    })();
  </script>
  <script>
    (function () {
      const body = document.body;
      const sidebar = document.getElementById('sidebarNav');
      const toggles = document.querySelectorAll('[data-sidebar-toggle]');
      const backdrop = document.querySelector('.sidebar-backdrop');
      const mediaQuery = window.matchMedia('(min-width: 900px)');

      function setAria(isOpen) {
        if (backdrop) {
          backdrop.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        }
        if (!sidebar) {
          return;
        }
        if (mediaQuery.matches) {
          sidebar.removeAttribute('aria-hidden');
        } else {
          sidebar.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        }
      }

      function closeSidebar() {
        body.classList.remove('sidebar-open');
        setAria(false);
      }

      function openSidebar() {
        if (!sidebar) { return; }
        body.classList.add('sidebar-open');
        setAria(true);
      }

      toggles.forEach(function (toggle) {
        toggle.addEventListener('click', function (event) {
          event.preventDefault();
          if (!sidebar) { return; }
          if (body.classList.contains('sidebar-open')) {
            closeSidebar();
          } else {
            openSidebar();
          }
        });
      });

      if (sidebar) {
        setAria(false);
      }

      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && body.classList.contains('sidebar-open')) {
          closeSidebar();
        }
      });

      mediaQuery.addEventListener('change', function (event) {
        if (event.matches) {
          closeSidebar();
        }
      });
    })();
  </script>
  <script>
    (function () {
      const toastStack = document.getElementById('toastStack');
      if (!toastStack || typeof bootstrap === 'undefined') { return; }
      const toasts = toastStack.querySelectorAll('.toast');
      toasts.forEach(function (toastEl) {
        const category = toastEl.dataset.category || 'info';
        toastEl.setAttribute('aria-live', category === 'danger' ? 'assertive' : 'polite');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      });
    })();
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
