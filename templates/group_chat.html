<!DOCTYPE html>
<html>
<head>
  <title>{{ group.name }}</title>
  <link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}">
</head>
<body>
    <div class="sidebar">
        <h2>Menu</h2>
        <a href="/">Home</a>
        <a href="/tasks">Task Manager</a>
        <a href="/titles">Team Member Manager</a>
        <a href="/calendar">Calendar</a>
        <a href="/overdue">Overdue Tasks</a>
        <a href="/groups">Group Chats</a>
        <a href="/settings">Settings</a>
        <a href="/logout">Logout</a>
      </div>
  <div class="main-content container">
    <h1>Group: {{ group.name }}</h1>
    <p><strong>Lead:</strong> {{ group.supervisor.capitalize() }}</p>

    <h2>Members</h2>
    <ul>
      {% for m in group.members %}
        <li>
          {{ m.capitalize() }}
          {% if session.role=='manager' and m!=group.supervisor %}
            <form style="display:inline" method="post"
                  action="{{ url_for('remove_group_member',group_id=group.id) }}">
              <input type="hidden" name="member" value="{{ m }}">
              <button type="submit">×</button>
            </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    {% if session.role=='manager' %}
      <form method="post" action="{{ url_for('add_group_member',group_id=group.id) }}">
        <select name="member">
          <option value="">— add member —</option>
          {% for u in users if u.username not in group.members %}
            <option value="{{ u.username }}">{{ u.display_name }}</option>
          {% endfor %}
        </select>
        <button type="submit">Add</button>
      </form>
    {% endif %}

    <h2>Tasks</h2>
    <ul class="task-list">
      {% for t in tasks %}
        <li class="task-item {% if t.done %}done{% elif t.due_date and t.due_date < now().date().isoformat() %}overdue{% endif %}">
          <form method="post"
                action="{{ url_for('toggle_group_task',group_id=group.id,idx=loop.index0) }}"
                enctype="multipart/form-data">
            <input type="checkbox" name="done" onchange="this.form.submit()"
                   {% if t.done %}checked{% endif %}>
            {{ t.text }}
            {% if not t.done %}
              <input type="file" name="photo">
            {% endif %}
          </form>
          <div class="task-meta">
            <small>Priority: {{ t.priority }}</small>
            <small>Due: {{ t.due_date or '—' }}</small>
            {% if t.done %}
              <small>By: {{ t.completed_by }} @
                {{ t.completed_at.split('T')[1] }} on
                {{ t.completed_at.split('T')[0] }}
              </small>
            {% endif %}
          </div>
          {% if t.notes %}
            <div class="task-notes">{{ t.notes }}</div>
          {% endif %}
          {% if t.photo %}
            <img src="{{ url_for('static', filename='uploads/'+t.photo) }}"
                 style="max-width:150px;margin-top:8px;">
          {% endif %}
        </li>
      {% endfor %}
    </ul>

    {% if session.role=='manager' or session.username==group.supervisor %}
      <h3>Add Task</h3>
      <form method="post" action="{{ url_for('add_group_task',group_id=group.id) }}">
        <input name="text" placeholder="Task text" required>
        <select name="priority">
          <option>Low</option><option selected>Medium</option><option>High</option>
        </select>
        <input type="date" name="due_date">
        <label><input type="checkbox" name="recurring"> Repeat weekly</label>
        <textarea name="notes" placeholder="Optional notes"></textarea>
        <button type="submit">Add</button>
      </form>
    {% endif %}
  </div>
</body>
</html>
