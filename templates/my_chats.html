{% extends "base.html" %}
{% block title %}My Group Chats{% endblock %}
{% block head_extra %}
  <style>
    .section-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .group-cards { display:flex; flex-direction:column; gap:10px; }
    .group-card { display:flex; align-items:center; justify-content:space-between; background:#f6f9fc; padding:12px 14px; border-radius:10px; text-decoration:none; }
    .group-card:hover { background:#eef4f9; }
    .group-title { font-weight:600; margin-bottom:2px; color:#222; }
    .group-last { color:#444; font-size:.95rem; }
    .group-last .last-time { margin-left:6px; opacity:.6; font-size:.85rem; }
    .badge { display:inline-block; min-width:24px; padding:2px 8px; border-radius:999px; background:#007acc; color:#fff; text-align:center; font-weight:600; font-size:.75rem; }
    .muted { opacity:.75; }
  </style>
{% endblock %}
{% block content %}
  <div class="container">
    <div class="section-head">
      <h1 style="margin:0;">My Group Chats</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        {% set total_unread = cards|sum(attribute='unread') if cards else 0 %}
        {% if total_unread > 0 %}
          <form method="post" action="{{ url_for('groups_mark_all_read') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="button-secondary" type="submit">Mark All Read ({{ total_unread }})</button>
          </form>
        {% endif %}
        {% if current_role == 'manager' %}
          <a class="button-secondary" href="{{ url_for('group_chat_manager') }}">Manage Groups</a>
        {% endif %}
      </div>
    </div>

    {% if cards and cards|length > 0 %}
      <div class="group-cards">
        {% for g in cards %}
          <a class="group-card" href="{{ url_for('view_group', group_id=g.id) }}">
            <div>
              <div class="group-title">{{ g.name }}</div>
              {% if g.last %}
                <div class="group-last">
                  <span class="last-sender">{{ g.last_sender_display }}</span>:
                  <span class="last-text">{{ g.last.text }}</span>
                  <span class="last-time">{{ g.last.timestamp|format_datetime }}</span>
                </div>
              {% else %}
                <div class="group-last muted"><em>No messages yet</em></div>
              {% endif %}
            </div>
            {% if g.unread and g.unread > 0 %}
              <span class="badge" title="{{ g.unread }} unread">{{ g.unread }}</span>
            {% endif %}
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">You&apos;re not in any groups yet, or there are no messages.</p>
    {% endif %}
  </div>
{% endblock %}
