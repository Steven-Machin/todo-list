{% extends "base.html" %}
{% block title %}Home - Dashboard{% endblock %}
{% block head_extra %}
  <style>
    .kpis { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-bottom:14px; }
    .kpi { background:#fff; border-radius:12px; padding:14px; }
    .kpi .label { font-size:.9rem; opacity:.7; }
    .kpi .value { font-size:1.6rem; font-weight:700; line-height:1.1; margin-top:4px; }
    .grid-2 { display:grid; grid-template-columns: 1.5fr 1fr; gap:16px; }
    .section-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .searchbar { display:flex; gap:8px; }
    .searchbar input[type="search"] { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #dfe6ee; }
    .searchbar button { white-space:nowrap; }
    .list-plain { list-style:none; padding:0; margin:0; }
    .list-plain > li { padding:10px 12px; border-radius:10px; background:#f6f9fc; margin-bottom:8px; }
    .muted { opacity:.75; }
    .button-link { background:none; border:none; color:#0d6efd; text-decoration:underline; padding:0; cursor:pointer; }
    .subtle { background:#fafbfd; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; margin-left:6px; line-height:1.6; }
    .chip-prio { background:#eef4ff; color:#2a4b8d; }
    .chip-overdue { background:#ffe3e3; color:#a30000; }
    .chip-today { background:#fff3cd; color:#7a5b00; }
    .badge { display:inline-block; min-width:24px; padding:2px 8px; border-radius:999px; background:#007acc; color:#fff; text-align:center; font-weight:600; font-size:.75rem; }
    .group-cards { display:flex; flex-direction:column; gap:10px; }
    .group-card { display:flex; align-items:center; justify-content:space-between; background:#f6f9fc; padding:12px 14px; border-radius:10px; text-decoration:none; }
    .group-card:hover { background:#eef4f9; }
    .group-title { font-weight:600; margin-bottom:2px; color:#222; }
    .group-last { color:#444; font-size:.95rem; }
    .group-last .last-text { opacity:.9; }
    .group-last .last-time { margin-left:6px; opacity:.6; font-size:.85rem; }
  </style>
{% endblock %}
{% block content %}
  <div class="container">
    <div class="section-head" style="margin-bottom:10px;">
      <h1 style="margin:0;">Welcome, {{ (prefs.display_name if prefs and prefs.display_name else (current_user_display or current_username|capitalize)) }}</h1>
      <form class="searchbar" method="get" action="{{ url_for('search') }}">
        <input type="search" name="q" placeholder="Search tasks, chats, and people..." required>
        <button type="submit">Search</button>
      </form>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Overdue</div>
        <div class="value">{{ (tasks|selectattr('overdue')|list)|length }}</div>
      </div>
      <div class="kpi">
        <div class="label">Due Today</div>
        <div class="value">{{ (tasks|selectattr('due_today')|list)|length }}</div>
      </div>
      <div class="kpi">
        <div class="label">Unread Messages</div>
        <div class="value">{{ group_cards|sum(attribute='unread') if group_cards else 0 }}</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="section-head">
          <h2 style="margin:0;">Latest Chats</h2>
          {% if group_cards and (group_cards|sum(attribute='unread')) > 0 %}
            <form method="post" action="{{ url_for('groups_mark_all_read') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="button-secondary" type="submit">Mark All Read</button>
            </form>
          {% endif %}
        </div>

        {% if group_cards and group_cards|length > 0 %}
          <div class="group-cards">
            {% for card in group_cards[:5] %}
              <a class="group-card" href="{{ url_for('view_group', group_id=card.id) }}">
                <div>
                  <div class="group-title">{{ card.name }}</div>
                  {% if card.last %}
                    <div class="group-last">
                      <span class="last-text">{{ card.last.sender|capitalize }}: {{ card.last.text[:40] }}{% if card.last.text|length > 40 %}...{% endif %}</span>
                      <span class="last-time">{{ card.last.timestamp|format_datetime }}</span>
                    </div>
                  {% else %}
                    <div class="group-last muted">No messages yet.</div>
                  {% endif %}
                </div>
                {% if card.unread > 0 %}
                  <span class="badge">{{ card.unread }}</span>
                {% endif %}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">No group activity yet.</p>
        {% endif %}

        <div style="margin-top:12px; display:flex; gap:8px;">
          {% if current_role == 'manager' %}
            <a class="button-secondary" href="{{ url_for('group_chat_manager') }}">Manage Group Chats</a>
          {% else %}
            <a class="button-secondary" href="{{ url_for('chats') }}">View All Chats</a>
          {% endif %}
        </div>
      </div>

      <div class="card subtle">
        <div class="section-head" style="margin-bottom:0;">
          <h2 style="margin:0;">Reminders</h2>
        </div>

        <form class="add-form" method="post" action="{{ url_for('add_reminder') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label for="r_text">Reminder</label>
          <input type="text" id="r_text" name="text" placeholder="What do you want to remember?" required>

          <label for="r_due">When (optional)</label>
          <input type="datetime-local" id="r_due" name="due_at">

          <button type="submit">Add Reminder</button>
        </form>

        {% if reminders and reminders|length > 0 %}
          <ul class="list-plain" style="margin-top:10px;">
            {% for r in reminders %}
              <li>
                <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px;">
                  <div>
                    <div style="font-weight:600;">
                      {% if r.done %}<s>{{ r.text }}</s>{% else %}{{ r.text }}{% endif %}
                    </div>
                    <div class="muted">
                      {% if r.nice %}{{ r.nice }}{% else %}No time{% endif %}
                      {% if r.is_due and not r.done %}<span class="chip chip-overdue">due</span>{% endif %}
                      {% if r.done %}<span class="chip chip-prio">done</span>{% endif %}
                    </div>
                  </div>
                  <div style="display:flex; gap:8px;">
                    <form method="post" action="{{ url_for('reminders_toggle', rid=r.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="button-secondary" type="submit">{{ 'Undo' if r.done else 'Done' }}</button>
                    </form>
                    <form method="post" action="{{ url_for('reminders_delete', rid=r.id) }}" onsubmit="return confirm('Delete this reminder?');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="button-secondary danger" type="submit">Delete</button>
                    </form>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted" style="margin-top:8px;">No reminders yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="card subtle" style="margin-top:16px;">
      <div class="section-head">
        <h2 style="margin:0;">Your Tasks</h2>
        <a class="button-secondary" href="{{ url_for('tasks_page') }}">Open Task Manager</a>
      </div>

      {% set overdue_list = tasks|selectattr('overdue')|list %}
      {% set today = tasks|selectattr('due_today')|list %}
      {% set upcoming = tasks|rejectattr('overdue')|rejectattr('due_today')|selectattr('done','equalto',False)|list %}

      <div class="grid-2" style="grid-template-columns: 1fr 1fr;">
        <div>
          <h3>Overdue</h3>
          {% if overdue_list and overdue_list|length > 0 %}
            <ul class="list-plain">
              {% for t in overdue_list[:5] %}
                <li>
                  <div style="font-weight:600;">{{ t.text }} <span class="chip chip-overdue">overdue</span></div>
                  <div class="muted">Assigned to {{ t.assigned_to }}{% if t.due_date or t.due %} - Due {{ (t.due or t.due_date) }}{% endif %}{% if t.recurring %} - Repeats {{ t.recurring|title }}{% endif %}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">No overdue tasks.</p>
          {% endif %}
        </div>

        <div>
          <h3>Due Today</h3>
          {% if today and today|length > 0 %}
            <ul class="list-plain">
              {% for t in today[:5] %}
                <li>
                  <div style="font-weight:600;">{{ t.text }} <span class="chip chip-today">today</span></div>
                  <div class="muted">Assigned to {{ t.assigned_to }}{% if t.due_date or t.due %} - Due {{ (t.due or t.due_date) }}{% endif %}{% if t.recurring %} - Repeats {{ t.recurring|title }}{% endif %}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">Nothing due today.</p>
          {% endif %}
        </div>
      </div>

      <div style="margin-top:8px;">
        <h3>Upcoming</h3>
        {% if upcoming and upcoming|length > 0 %}
          <ul class="list-plain">
            {% for t in upcoming[:5] %}
              <li>
                <div style="font-weight:600;">
                  {{ t.text }}
                  <span class="chip chip-prio">{{ t.priority }}</span>
                </div>
                <div class="muted">Assigned to {{ t.assigned_to }}{% if t.due_date or t.due %} - Due {{ (t.due or t.due_date) }}{% endif %}{% if t.recurring %} - Repeats {{ t.recurring|title }}{% endif %}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">No upcoming tasks.</p>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
